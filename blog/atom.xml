<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="atom.xsl"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://your-docusaurus-site.example.com/blog</id>
    <title>Anh T. Tra Blog</title>
    <updated>2024-05-12T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://your-docusaurus-site.example.com/blog"/>
    <subtitle>Anh T. Tra Blog</subtitle>
    <icon>https://your-docusaurus-site.example.com/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Conda + Poetry = All You Need]]></title>
        <id>https://your-docusaurus-site.example.com/blog/conda-and-poetry-are-all-you-need</id>
        <link href="https://your-docusaurus-site.example.com/blog/conda-and-poetry-are-all-you-need"/>
        <updated>2024-05-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Poetry Typography]]></summary>
        <content type="html"><![CDATA[<p><img decoding="async" loading="lazy" alt="Poetry Typography" src="https://your-docusaurus-site.example.com/assets/images/banner-05a561933564b3e23092bc8b8acd9835.png" width="1962" height="852" class="img_ev3q"></p>
<p><code>Poetry</code> is being used more and more in Python project as a very convenient tool for managing dependencies. Since conda is a great tool for handling virtual environment, the combination between <code>conda</code> and <code>poetry</code> help Python projects well-organized and perfectly isolated.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="project-initialization-using-conda-and-poetry">Project Initialization Using <code>conda</code> and <code>poetry</code><a href="https://your-docusaurus-site.example.com/blog/conda-and-poetry-are-all-you-need#project-initialization-using-conda-and-poetry" class="hash-link" aria-label="Direct link to project-initialization-using-conda-and-poetry" title="Direct link to project-initialization-using-conda-and-poetry">​</a></h2>
<p>Install <code>conda/miniconda</code></p>
<ul>
<li><a href="https://conda.io/projects/conda/en/latest/user-guide/install/macos.html" target="_blank" rel="noopener noreferrer">https://conda.io/projects/conda/en/latest/user-guide/install/macos.html</a></li>
</ul>
<p>Create a new <code>conda</code> environment</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">conda create -n &lt;name-of-env&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">conda activate &lt;name-of-env&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(name-of-env) conda install python=&lt;python-version&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install <code>poetry</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(name-of-env) pip install poetry</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>or using <code>conda</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(name-of-env) conda install poetry</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Initialize project</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(name-of-env) mkdir &lt;project-name&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(name-of-env) cd &lt;project-name&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(name-of-env) poetry init</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Note:</strong> If you got this error <code>ModuleNotFoundError: No module named 'chardet'</code>, you should install the <code>charset</code> library as below before reinitializing your project. This error may happen when installing <code>poetry</code> using <code>conda</code>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">conda install -c conda-forge charset-normalizer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-tips-with-conda">Other Tips with <code>conda</code><a href="https://your-docusaurus-site.example.com/blog/conda-and-poetry-are-all-you-need#other-tips-with-conda" class="hash-link" aria-label="Direct link to other-tips-with-conda" title="Direct link to other-tips-with-conda">​</a></h2>
<ul>
<li>Install node in conda:</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> conda install -c conda-forge nodejs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Autocompletion in zsh: <a href="https://github.com/conda-incubator/conda-zsh-completion" target="_blank" rel="noopener noreferrer">https://github.com/conda-incubator/conda-zsh-completion</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="https://your-docusaurus-site.example.com/blog/conda-and-poetry-are-all-you-need#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://medium.com/@silvinohenriqueteixeiramalta/conda-and-poetry-a-harmonious-fusion-8116895b6380" target="_blank" rel="noopener noreferrer">https://medium.com/@silvinohenriqueteixeiramalta/conda-and-poetry-a-harmonious-fusion-8116895b6380</a></li>
<li><a href="https://michhar.github.io/2023-07-poetry-with-conda/" target="_blank" rel="noopener noreferrer">https://michhar.github.io/2023-07-poetry-with-conda/</a></li>
</ul>]]></content>
        <author>
            <name>Anh T. Tra</name>
            <uri>https://github.com/anhttra</uri>
        </author>
        <category label="Poetry" term="Poetry"/>
        <category label="Conda" term="Conda"/>
        <category label="Python" term="Python"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Revisiting the easy-lb-proxy]]></title>
        <id>https://your-docusaurus-site.example.com/blog/revisiting-the-easy-lb-proxy</id>
        <link href="https://your-docusaurus-site.example.com/blog/revisiting-the-easy-lb-proxy"/>
        <updated>2023-10-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[HAProxy Stats Page]]></summary>
        <content type="html"><![CDATA[<p><img decoding="async" loading="lazy" alt="HAProxy Stats Page" src="https://your-docusaurus-site.example.com/assets/images/banner-e355e7c8fbce4d0598c74d02aa755206.png" width="2000" height="460" class="img_ev3q"></p>
<p>The <code>easy-lb-proxy</code> was a nice open source given by <a href="https://blog.miguelgrinberg.com/post/about-me" target="_blank" rel="noopener noreferrer">Miguel Grinberg</a> to provide a simple way to deploy <code>haproxy</code>, <code>confd</code> using Docker. It was also used in the <code>micro_flack</code> demo presented by Miguel at PyCon 2017 on May 17th, 2017. However, it is 6 years since last commit was pushed to the <a href="https://github.com/miguelgrinberg/easy-lb-haproxy" target="_blank" rel="noopener noreferrer">source-code repository</a>. Thus, some modifications are required if we want to apply the source-code with modern hardwares (e.g. ARM architecture) and softwares (latest <code>haproxy</code> and confd). This post will discuss how to develop a Docker image installing latest <code>haproxy</code> and <code>confd</code> versions with ability run with new MacBook (M1/M2 CPUs).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-easy-lb-haproxy-is">What <code>easy-lb-haproxy</code> is?<a href="https://your-docusaurus-site.example.com/blog/revisiting-the-easy-lb-proxy#what-easy-lb-haproxy-is" class="hash-link" aria-label="Direct link to what-easy-lb-haproxy-is" title="Direct link to what-easy-lb-haproxy-is">​</a></h2>
<blockquote>
<p>Accoriding the the <code>easy-lb-haproxy</code> README, it is a repository that defines a load balancer container for Docker, based on <code>haproxy</code>, <code>confd</code> and <code>etcd</code>.</p>
</blockquote>
<p>The <code>haproxy</code> load balancer will be gracefully reload when its configuration is changes by <code>confd</code>, which pulls configuration data from a <code>ectd</code> node/cluster.</p>
<p>In <code>easy-lb-haproxy</code> repository, <code>haproxy</code> is the version 1.7 (for alpine) while <code>confd</code> is binary file for running on <code>amd64/alpine</code> environment as shown in the Dockerfile below:</p>
<div class="language-Dockerfile language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM haproxy:1.7-alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN apk add --update curl &amp;&amp; rm -rf /var/cache/apk/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN mkdir -p /etc/confd/conf.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN mkdir -p /etc/confd/templates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY confd .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN chmod +x confd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY haproxy.toml /etc/confd/conf.d/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY haproxy.tmpl /etc/confd/templates/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY boot.sh .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY watcher.sh .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EXPOSE 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD ["./boot.sh"]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-easy-lb-haproxy-need-being-revisited">Why <code>easy-lb-haproxy</code> Need Being Revisited?<a href="https://your-docusaurus-site.example.com/blog/revisiting-the-easy-lb-proxy#why-easy-lb-haproxy-need-being-revisited" class="hash-link" aria-label="Direct link to why-easy-lb-haproxy-need-being-revisited" title="Direct link to why-easy-lb-haproxy-need-being-revisited">​</a></h2>
<p>At the time writing this post, when running the image of <code>easy-lb-haproxy</code> (miguelgrinberg/easy-lb-haproxy) on Macbook M1, we will got this warning:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(base) ~ % docker run -d miguelgrinberg/easy-etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Unable to find image 'miguelgrinberg/easy-etcd:latest' locally</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">latest: Pulling from miguelgrinberg/easy-etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">627beaf3eaaf: Already exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9407f1b3f535: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">f45e820e1b24: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1da0226fd80a: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e71e952e8745: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">da4180eebdd1: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Digest: sha256:b46545c321667c591f78e6f91b4c856c25350cb27e51c5f6304e43a6e9881416</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status: Downloaded newer image for miguelgrinberg/easy-etcd:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: The requested image's platform (linux/amd64) does not match the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">detected host platform (linux/arm64/v8) and no specific platform was requested</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When logging out the docker container, we will see this error:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(base) ~ % docker ps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONTAINER ID   IMAGE                            COMMAND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3241869758a2   miguelgrinberg/easy-lb-haproxy   "/docker-entrypoint.…"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(base) ~ % docker logs 3241869758a2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runtime: failed to create new OS thread (have 2 already; errno=22)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fatal error: runtime.newosproc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This problem can also be faced when running the image on other ARM hardware, e.g. Raspberry Pi. It needs to make some modifications to make it run on these hardwares.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-modify-easy-lb-haproxy-docker-image">How to Modify <code>easy-lb-haproxy</code> Docker Image?<a href="https://your-docusaurus-site.example.com/blog/revisiting-the-easy-lb-proxy#how-to-modify-easy-lb-haproxy-docker-image" class="hash-link" aria-label="Direct link to how-to-modify-easy-lb-haproxy-docker-image" title="Direct link to how-to-modify-easy-lb-haproxy-docker-image">​</a></h2>
<p>In order to modify <code>easy-lb-haproxy</code> to run on new hardwares and softwares, we need to: 1. change base Docker Image, 2. rebuild <code>confd</code> , and 3. rebuild <code>easy-lb-haproxy</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-use-new-docker-image">Step 1: Use New Docker Image<a href="https://your-docusaurus-site.example.com/blog/revisiting-the-easy-lb-proxy#step-1-use-new-docker-image" class="hash-link" aria-label="Direct link to Step 1: Use New Docker Image" title="Direct link to Step 1: Use New Docker Image">​</a></h3>
<p>Since the original <code>easy-lb-haproxy</code> used base image of <code>haproxy:1.7-alpine</code>, we will choose to use the newest official haproxy docker images on <code>alpine</code>, which is <code>haproxy:alpine3.18</code> . We also need another docker image with <code>golang</code> installed to build confd, so we choose the official golang image with the same <code>alpine3.18</code> , which is <code>1.20.10-alpine3.18</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-rebuild-confd">Step 2: Rebuild <code>confd</code><a href="https://your-docusaurus-site.example.com/blog/revisiting-the-easy-lb-proxy#step-2-rebuild-confd" class="hash-link" aria-label="Direct link to step-2-rebuild-confd" title="Direct link to step-2-rebuild-confd">​</a></h3>
<p>You can follow the instruction at <a href="https://github.com/kelseyhightower/confd" target="_blank" rel="noopener noreferrer">https://github.com/kelseyhightower/confd</a> for building <code>confd</code> from source code. To build it with <code>alpine</code> docker, just run:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(base) ~ % docker run -it golang:1.20.10-alpine3.18 sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/go # apk update &amp;&amp; apk add git make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/go # mkdir -p $GOPATH/src/github.com/kelseyhightower</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/go # git clone https://github.com/kelseyhightower/confd.git \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$GOPATH/src/github.com/kelseyhightower/confd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/go # cd $GOPATH/src/github.com/kelseyhightower/confd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/go/src/github.com/kelseyhightower/confd # make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/go/src/github.com/kelseyhightower/confd # ls bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">confd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-rebuild-easy-lb-proxy">Step 3: Rebuild easy-lb-proxy<a href="https://your-docusaurus-site.example.com/blog/revisiting-the-easy-lb-proxy#step-3-rebuild-easy-lb-proxy" class="hash-link" aria-label="Direct link to Step 3: Rebuild easy-lb-proxy" title="Direct link to Step 3: Rebuild easy-lb-proxy">​</a></h3>
<p>We will follow the <a href="https://github.com/anhttra/revisiting-easy-lb-haproxy/blob/master/Dockerfile" target="_blank" rel="noopener noreferrer">Dockerfile</a> in the repo to build our new <code>easy-lb-proxy</code> image, except that we will use the base image in the step 1 and the latest <code>confd</code> obtained in step 2. The new Dockerfile will be:</p>
<div class="language-Dockerfile language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM golang:1.20.10-alpine3.18 as build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN apk add --update git make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN mkdir -p $GOPATH/src/github.com/kelseyhightower &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git clone https://github.com/kelseyhightower/confd.git \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $GOPATH/src/github.com/kelseyhightower/confd &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cd $GOPATH/src/github.com/kelseyhightower/confd &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM haproxy:alpine3.18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USER root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN apk update &amp;&amp; apk add curl &amp;&amp; rm -rf /var/cache/apk/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN mkdir -p /etc/confd/conf.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN mkdir -p /etc/confd/templates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY --from=build /go/src/github.com/kelseyhightower/confd/bin/confd .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN chmod +x confd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY haproxy.toml /etc/confd/conf.d/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY haproxy.tmpl /etc/confd/templates/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY boot.sh .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY watcher.sh .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EXPOSE 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD ["./boot.sh"]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then we can run the new Docker image without the error as <code>runtime: failed to create new OS thread (have 2 already; errno=22)</code>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(base) % docker build -t revisit-easy-lb-haproxy .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(base) % docker run -it revisit-easy-lb-haproxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13T13:42:04Z b491152c349a ./confd[9]: INFO Backend set to etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13T13:42:04Z b491152c349a ./confd[9]: INFO Starting confd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion--future-works">Conclusion &amp; Future Works<a href="https://your-docusaurus-site.example.com/blog/revisiting-the-easy-lb-proxy#conclusion--future-works" class="hash-link" aria-label="Direct link to Conclusion &amp; Future Works" title="Direct link to Conclusion &amp; Future Works">​</a></h2>
<p>In this post, we show how to modify the <code>easy-lb-haproxy</code> source code to achieve the new Docker image, which is able to run on new hardware with new softwares. However, the current confd template files (<code>haproxy.tmpl</code> and <code>haproxy.toml</code>) do not work correctly by some reasons (API updates of <code>etcd</code>, changes of <code>confd</code> template syntax, and changes in the way <code>haproxy</code> is reload). We will cover the fix for these issues in the next post.</p>]]></content>
        <author>
            <name>Anh T. Tra</name>
            <uri>https://github.com/anhttra</uri>
        </author>
        <category label="haproxy" term="haproxy"/>
        <category label="confd" term="confd"/>
        <category label="LB" term="LB"/>
    </entry>
</feed>