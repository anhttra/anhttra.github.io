<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="markdown.css">
    <title>Document</title>
</head>

<body>
    <style>
        body {
            max-width: 1000px;
            margin: 0 auto;
        }
    </style>
    

        <p>The <code>easy-lb-proxy</code> was a nice open source given by <a
                href=\"https://blog.miguelgrinberg.com/post/about-me?ref=anhttra.digitalpress.blog\"
                rel=\"noreferrer\">Miguel
                Grinberg</a> to provide a simple way to deploy <code>haproxy</code>, <code>confd</code> using Docker. It
            was
            also used in the <code>micro_flack</code> demo presented by Miguel at PyCon 2017 on May 17th, 2017. However,
            it is 6
            years since last commit was pushed to the <a
                href=\"https://github.com/miguelgrinberg/easy-lb-haproxy?ref=anhttra.digitalpress.blog\"
                rel=\"noreferrer\">source-code repository</a>. Thus, some modifications are required if we want to apply
            the
            source-code with modern hardwares (e.g. ARM architecture) and softwares (latest <code>haproxy</code> and
            <code>confd</code>). This post will discuss how to develop a Docker image installing latest
            <code>haproxy</code> and
            <code>confd</code> versions with ability run with new MacBook (M1/M2 CPUs).
        </p>
        <h2 id=\"what-easy-lb-haproxy-is\">What <code>easy-lb-haproxy</code> is?</h2>
        <blockquote>Accoriding the the <code>easy-lb-haproxy</code> README, it is a repository that defines a load
            balancer
            container for Docker, based on haproxy, confd and etcd. </blockquote>
        <p>The <code>haproxy</code> load balancer will be gracefully reload when its configuration is changes by
            <code>confd</code>, which pulls configuration data from a <code>ectd</code> node/cluster.
        </p>
        <p>In <code>easy-lb-haproxy</code> repository, <code>haproxy</code> is the version 1.7 (for alpine) while
            <code>confd</code> is binary file for running on <code>amd64/alpine</code> environment as shown in the
            Dockerfile
            below:
        </p>
        <pre><code class=\"language-Dockerfile\">FROM haproxy:1.7-alpine<br>RUN apk add --update curl &amp;&amp; rm -rf /var/cache/apk/*<br>RUN mkdir -p /etc/confd/conf.d<br>RUN mkdir -p /etc/confd/templates<br>COPY confd .<br>RUN chmod +x confd<br>COPY haproxy.toml /etc/confd/conf.d/<br>COPY haproxy.tmpl /etc/confd/templates/<br>COPY boot.sh .<br>COPY watcher.sh .<br>EXPOSE 80<br>CMD [\"./boot.sh\"]</code></pre>
        <h2 id=\"why-easy-lb-haproxy-need-being-revisited\">Why <code>easy-lb-haproxy</code> Need Being Revisited?</h2>
        <p>At the time writing this post, when running the image of <code>easy-lb-haproxy</code>
            (miguelgrinberg/easy-lb-haproxy) on Macbook M1, we will got this warning:</p>
        <pre><code class=\"language-bash\">(base) ~ % docker run -d miguelgrinberg/easy-etcd<br><br>Unable to find image 'miguelgrinberg/easy-etcd:latest' locally<br>latest: Pulling from miguelgrinberg/easy-etcd<br>627beaf3eaaf: Already exists<br>9407f1b3f535: Pull complete<br>f45e820e1b24: Pull complete<br>1da0226fd80a: Pull complete<br>e71e952e8745: Pull complete<br>da4180eebdd1: Pull complete<br>Digest: sha256:b46545c321667c591f78e6f91b4c856c25350cb27e51c5f6304e43a6e9881416<br>Status: Downloaded newer image for miguelgrinberg/easy-etcd:latest<br>WARNING: The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested</code></pre>
        <p>When logging out the docker container, we will see this error:</p>
        <pre><code class=\"language-bash\">(base) ~ % docker ps<br>CONTAINER ID   IMAGE                            COMMAND                  CREATED         STATUS         PORTS                NAMES<br>3241869758a2   miguelgrinberg/easy-lb-haproxy   \"/docker-entrypoint.â€¦\"   3 minutes ago   Up 3 minutes   0.0.0.0:80-&gt;80/tcp   admiring_hawking<br>(base) ~ % docker logs 3241869758a2<br>runtime: failed to create new OS thread (have 2 already; errno=22)<br>fatal error: runtime.newosproc</code></pre>
        <p>This problem can also be faced when running the image on other ARM hardware, e.g. Raspberry Pi. It needs to
            make some
            modifications to make it run on these hardwares.</p>
        <h2 id=\"how-to-modify-easy-lb-haproxy-docker-image\">How to Modify <code>easy-lb-haproxy</code> Docker Image?
        </h2>
        <p>In order to modify <code>easy-lb-haproxy</code> to run on new hardwares and softwares, we need to: 1. change
            base
            Docker Image, 2. rebuild <code>confd</code> , and 3. rebuild <code>easy-lb-haproxy</code> . </p>
        <h3 id=\"step-1-use-new-docker-image\">Step 1: Use New Docker Image</h3>
        <p>Since the original <code>easy-lb-haproxy</code> used base image of <code>haproxy:1.7-alpine</code>, we will
            choose to
            use the newest official <code>haproxy</code> docker images on <code>alpine</code>, which is
            <code>haproxy:alpine3.18</code> . We also need another docker image with <code>golang</code> installed to
            build
            <code>confd</code>, so we choose the official <code>golang</code> image with the same
            <code>alpine3.18</code> ,
            which is <code>1.20.10-alpine3.18</code> .
        </p>
        <h3 id=\"step-2-rebuild-confd\">Step 2: Rebuild <code>confd</code></h3>
        <p>You can follow the instruction at <a
                href=\"https://github.com/kelseyhightower/confd?ref=anhttra.digitalpress.blog\">https://github.com/kelseyhightower/confd</a>
            for building <code>confd</code> from source code. To build it with <code>alpine</code> docker, just run:</p>
        <figure class=\"kg-card kg-code-card\">
            <pre><code class=\"language-bash\">docker run -it golang:1.20.10-alpine3.18 sh</code></pre>
            <figcaption>
                <p><span style=\"white-space: pre-wrap;\">Run shell </span><code spellcheck=\"false\"
                        style=\"white-space: pre-wrap;\"><span>sh</span></code><span style=\"white-space: pre-wrap;\">
                        inside docker</span></p>
            </figcaption>
        </figure>
        <figure class=\"kg-card kg-code-card\">
            <pre><code class=\"language-sh\">/go # apk update &amp;&amp; apk add git make<br></code></pre>
            <figcaption>
                <p><span style=\"white-space: pre-wrap;\">Install </span><code spellcheck=\"false\" style=\"white-space:
                        pre-wrap;\"><span>git</span></code><span style=\"white-space: pre-wrap;\"> and </span><code
                        spellcheck=\"false\" style=\"white-space: pre-wrap;\"><span>make</span></code><span
                        style=\"white-space: pre-wrap;\"> . Note that \"/go #\" means we are inside the </span><code
                        spellcheck=\"false\" style=\"white-space: pre-wrap;\"><span>sh</span></code><span
                        style=\"white-space: pre-wrap;\"> shell of
                        the container.</span></p>
            </figcaption>
        </figure>
        <figure class=\"kg-card kg-code-card\">
            <pre><code class=\"language-sh\">/go # mkdir -p $GOPATH/src/github.com/kelseyhightower<br>/go # git clone https://github.com/kelseyhightower/confd.git $GOPATH/src/github.com/kelseyhightower/confd<br>/go # cd $GOPATH/src/github.com/kelseyhightower/confd<br>/go/src/github.com/kelseyhightower/confd # make</code></pre>
            <figcaption>
                <p><span style=\"white-space: pre-wrap;\">Clone the source code and build.</span></p>
            </figcaption>
        </figure>
        <figure class=\"kg-card kg-code-card\">
            <pre><code class=\"language-sh\">/go/src/github.com/kelseyhightower/confd # ls bin<br>confd</code></pre>
            <figcaption>
                <p><span style=\"white-space: pre-wrap;\">You should now have confd in your&nbsp;</span><code
                        spellcheck=\"false\" style=\"white-space: pre-wrap;\"><span>bin/</span></code><span
                        style=\"white-space: pre-wrap;\">&nbsp;directory.</span></p>
            </figcaption>
        </figure>
        <h3 id=\"step-3-rebuild-easy-lb-proxy\">Step 3: Rebuild <code>easy-lb-proxy</code></h3>
        <p>We will follow the <a
                href=\"https://github.com/anhttra/revisiting-easy-lb-haproxy/blob/master/Dockerfile?ref=anhttra.digitalpress.blog\"
                rel=\"noreferrer\">Dockerfile</a> in the repo to build our new <code>easy-lb-proxy</code> image, except
            that we
            will use the base image in the step 1 and the latest <code>confd</code> obtained in step 2. The new
            Dockerfile will
            be:</p>
        <pre><code class=\"language-Dockerfile\">
        FROM golang:1.20.10-alpine3.18 as build<br>RUN apk add --update git make<br>RUN mkdir -p $GOPATH/src/github.com/kelseyhightower &amp;&amp; \\<br>    git clone https://github.com/kelseyhightower/confd.git $GOPATH/src/github.com/kelseyhightower/confd &amp;&amp; \\<br>    cd $GOPATH/src/github.com/kelseyhightower/confd &amp;&amp; \\<br>    make<br><br>FROM haproxy:alpine3.18<br>USER root<br>RUN apk update &amp;&amp; apk add curl &amp;&amp; rm -rf /var/cache/apk/*<br>RUN mkdir -p /etc/confd/conf.d<br>RUN mkdir -p /etc/confd/templates<br>COPY --from=build /go/src/github.com/kelseyhightower/confd/bin/confd .<br>RUN chmod +x confd<br>COPY haproxy.toml /etc/confd/conf.d/<br>COPY haproxy.tmpl /etc/confd/templates/<br>COPY boot.sh .<br>COPY watcher.sh .<br>EXPOSE 80<br>CMD [\"./boot.sh\"]</code></pre>
        <p>Then we can run the new Docker image without the error as
            <code>runtime: failed to create new OS thread (have 2 already; errno=22)</code> .
        </p>
        <pre><code class=\"language-bash\">(base) % docker build -t revisit-easy-lb-haproxy .<br>(base) % docker run -it revisit-easy-lb-haproxy<br>2023-10-13T13:42:04Z b491152c349a ./confd[9]: INFO Backend set to etcd<br>2023-10-13T13:42:04Z b491152c349a ./confd[9]: INFO Starting confd<br>2023-10-13T13:42:04Z b491152c349a ./confd[9]: INFO Backend source(s) set to -config-file</code></pre>

        <h2 id=\"conclusion-future-works\">Conclusion &amp; Future Works</h2>

        <p>In this post, we show how to modify the <code>easy-lb-haproxy</code> source code to achieve the new Docker
            image,
            which is able to run on new hardware with new softwares. However, the current <code>confd</code> template
            files
            (<code>haproxy.tmpl</code> and <code>haproxy.toml</code>) do not work correctly by some reasons (API updates
            of
            <code>etcd</code>, changes of <code>confd</code> template syntax, and changes in the way
            <code>haproxy</code> is
            reload). We will cover the fix for these issues in the next post.
        </p>

    </div>

</body>

</html>